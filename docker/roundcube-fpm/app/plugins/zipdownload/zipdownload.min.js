/**
 * ZipDownload plugin script
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (c) The Roundcube Dev Team
 *
 * The JavaScript code in this page is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 */
function rcmail_zipdownload(e){var i,a,n,l;if("eml"==e)return a=rcmail.get_single_uid(),void rcmail.goto_url("viewsource",rcmail.params_from_uid(a,{_save:1}),!1,!0);rcmail.message_list&&1<rcmail.message_list.get_selection().length&&(i=[],a=rcmail.selection_post_data(),l="zipdownload-"+(new Date).getTime(),n=$("<iframe>").attr({name:l,style:"display:none"}),l=$("<form>").attr({target:l,style:"display: none",method:"post",action:rcmail.url("mail/plugin.zipdownload.messages")}),a._mode=e,a._token=rcmail.env.request_token,$.each(a,function(e,a){if("object"==typeof a&&1<a.length)for(var n=0;n<a.length;n++)i.push($("<input>").attr({type:"hidden",name:e+"[]",value:a[n]}));else i.push($("<input>").attr({type:"hidden",name:e,value:a}))}),n.appendTo(document.body),l.append(i).appendTo(document.body).submit())}function rcmail_zipdownload_menu(e){var a=rcmail.message_list.get_selection().length;return rcmail.enable_command("download-eml",1==a),rcmail.enable_command("download-mbox","download-maildir",1<a),rcmail.command("menu-open","zipdownload-menu",e&&e.target?e.target:rcmail.env.download_link,e),!1}window.rcmail&&rcmail.addEventListener("init",function(e){rcmail.register_command("download-eml",function(){rcmail_zipdownload("eml")}),rcmail.register_command("download-mbox",function(){rcmail_zipdownload("mbox")}),rcmail.register_command("download-maildir",function(){rcmail_zipdownload("maildir")}),rcmail.message_list&&rcmail.message_list.addEventListener("select",function(e){e=e.get_selection().length;rcmail.enable_command("download",0<e)}),rcmail.addEventListener("beforedownload",rcmail_zipdownload_menu),$.each(rcmail.buttons.download||[],function(){var e=$("#"+this.id),a=$("span",e);a.length||(a=$("<span>"),e.html("").append(a)),e.attr("aria-haspopup","true"),a.text(rcmail.get_label("zipdownload.download")),rcmail.env.download_link=e})});
